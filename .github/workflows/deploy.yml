name: Deploy Pipeline with Docker and Kubernetes

on:
  push:
    branches:
      - 'feature/**'
      - 'develop'
      - 'main'
  workflow_dispatch:

permissions:
  packages: write
  contents: read
  id-token: write

env:
  # ConfiguraÃ§Ãµes do Projeto
  SOLUTION_FILE: 'Postech.Fiap.Hackathon.VideoProcessing.WebApi.sln'
  TEST_PROJECT: 'tests/Postech.Fiap.Hackathon.VideoProcessing.WebApi.UnitsTests'
  DOCKERFILE_PATH: 'src/Postech.Fiap.Hackathon.VideoProcessing.WebApi/Dockerfile'
  DOCKER_IMAGE_NAME: 'postech-video-processing-webapi'
  COVERAGE_FILE: 'coverage.xml'

  # ConfiguraÃ§Ãµes do Docker
  DOCKER_REGISTRY: 'themisterbondy'
  DOCKER_IMAGE_TAG: '${{ github.sha }}'

  # ConfiguraÃ§Ãµes do Kubernetes
  RESOURCE_GROUP: 'rg-fiap-hackathon'
  CLUSTER_NAME: 'fiap-hackathon-aks'
  K8S_NAMESPACE: 'fiap-hackathon'
  HELM_CHART_PATH: './charts/webapi/'

jobs:
  deploy:
#    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›Žï¸ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Instalar .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: ðŸš€ Restaurar dependÃªncias
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: ðŸ”¨ Compilar soluÃ§Ã£o
        run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore

      - name: ðŸ§ª Rodar testes
        run: |
          dotnet test ${{ env.TEST_PROJECT }} --configuration Release --no-build

      - name: ðŸ·ï¸ Definir tag da imagem Docker (SHA curto)
        id: docker_tag
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          echo "DOCKER_IMAGE_TAG=${SHORT_SHA}" >> $GITHUB_ENV

      - name: ðŸ³ Login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ—ï¸ Build e Push da Imagem Docker
        uses: docker/build-push-action@v3
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}
            ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.source=${{ github.repository }}

      - name: ðŸ” Autenticar com o Azure
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: ðŸ“¥ Obter ConfiguraÃ§Ã£o do Kubernetes
        run: |
          az aks get-credentials --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.CLUSTER_NAME }} --overwrite-existing

      - name: ðŸ“¦ Instalar o Helm
        uses: azure/setup-helm@v3

      - name: ðŸ” Aplicar ConfigMap do Secret
        run: |
          echo "${{ secrets.CONFIG_MAP_YAML }}" > config.yaml
          kubectl apply -f config.yaml

      - name: ðŸš€ Deploy da API no Kubernetes
        run: |
          helm upgrade --install ${{ env.DOCKER_IMAGE_NAME }} ${{ env.HELM_CHART_PATH }} \
            --namespace ${{ env.K8S_NAMESPACE }} \
            --set image.repository=${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }} \
            --set image.tag=${{ env.DOCKER_IMAGE_TAG }} \
            --create-namespace